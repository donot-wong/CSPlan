// various functions for auditing viewstate
//--------------------------------------------------------------------------------------------------------
function ViewStateMACisEnabled(viewstateStr)
{	
	//trace("viewstate: " + viewstateStr);
	var vs = new ViewState(viewstateStr);
	// a vulnerable VIEWSTATE
	// vs = "/wEPDwUKMTI5MTY4NjkwOA8WAh4JVUlDdWx0dXJlBQVyby1STxYCZg9kFgRmD2QWBAIDDxYCHgRocmVmBQwvZGVmYXVsdC5jc3NkAgYPFgIfAQUqL0FwcF9UaGVtZXMvRGVmYXVsdFRoZW1lL3Njcm9sbGFibGV0YWIuY3NzZAIBD2QWDAIBDxYCHwEFAS8WAgIBDxYCHgNzcmMFDS9pbWcvbG9nby5naWZkAgIPFgIeBFRleHQFyQQ8c2NyaXB0IGxhbmd1YWdlPSdKYXZhU2NyaXB0JyB0eXBlPSd0ZXh0L2phdmFzY3JpcHQnPgogdmFyIG0zX3IgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqOTk5OTk5OTk5OTkpOwoKPCEtLQpkb2N1bWVudC53cml0ZSAoIjwiICsgInNjcmlwdCBsYW5ndWFnZT0nSmF2YVNjcmlwdCcgdHlwZT0ndGV4dC9qYXZhc2NyaXB0JyBzcmM9JyIpO2RvY3VtZW50LndyaXRlICgiaHR0cDovL2Fkcy5maW56b29tLnJvLy9hZGpzLnBocD93aGF0PXpvbmU6MjYmYW1wO2NiPSIrbTNfcik7aWYoZG9jdW1lbnQucmVmZXJyZXIpZG9jdW1lbnQud3JpdGUoIiZhbXA7cmVmZXJlcj0iICsgZXNjYXBlKGRvY3VtZW50LnJlZmVycmVyKSk7ZG9jdW1lbnQud3JpdGUoIic+PCIgKyAiL3NjcmlwdD4iKTsKLy8tLT4KPC9zY3JpcHQ+PG5vc2NyaXB0PjxhIGNsYXNzPSdzdHItdHh0LXNlYycgaHJlZj0naHR0cDovL2Fkcy5maW56b29tLnJvLy9hZGNsaWNrLnBocCcgdGFyZ2V0PSdfYmxhbmsnPjxpbWcgc3JjPSdodHRwOi8vYWRzLmZpbnpvb20ucm8vL2Fkdmlldy5waHA/d2hhdD16b25lOjI2JyBib3JkZXI9JzAnIGFsdD0nJz48L2E+PC9ub3NjcmlwdD5kAgMPZBYkZg8PFgQeC05hdmlnYXRlVXJsBQEvHghJbWFnZVVybAUNL2ltZy9ob21lLmdpZmRkAgEPDxYGHwQFCy9JbmZvL05ld3MvHwMFMEZpbnpvb20ucm8gTGFuc2VhemEgQ2FsY3VsYXRvcnVsIHBlbnRydSBEZXBveml0ZR4HVG9vbFRpcAXHAUZpbnpvb20ucm8gTGFuc2VhemEgQ2FsY3VsYXRvcnVsIHBlbnRydSBEZXBveml0ZQ0KOC8yNy8yMDE0DQoNCkZpbnpvb20ucm8gbGFuc2VhemEgdW4gbm91IGNhbGN1bGF0b3IgbWVuaXQgc2EtaSBhanV0ZSBwZSBjZWkgY2FyZSBkb3Jlc2Mgc2EgYWZsZSBjYXJlIGVzdGUgcmVudGFiaWxpdGF0ZWEgZGVwb3ppdGVsb3IgY29uc3RpdHVpdGUgcyAuLi5kZAICDw8WBB8EBREvU2l0ZU1hcFRyZWUuYXNweB8FBQovaW1nL2kuZ2lmZGQCAw8PFgIfBAUYL3Jlc3Vyc2Utd2VibWFzdGVyaS5hc3B4ZGQCBA8PFgIfBAUUL2Fib3V0L3BhcnRuZXJzLmFzcHhkZAIFDw8WAh8EBRMvQWJvdXQvRGVmYXVsdC5hc3B4ZGQCBg8PFgIfBAUTL0FkdmVydGlzZW1lbnQuYXNweGRkAgcPFgIfAgUPL2ltZy9zZWFyY2guZ2lmZAIIDw8WAh8EBRUvQ3JlZGl0cy9kZWZhdWx0LmFzcHhkZAIJDw8WAh8EBR8vQ2FyZHVyaS9DYXJkdXJpLWRlLWNyZWRpdC5hc3B4ZGQCCg8PFgIfBAUZL2Vjb25vbWlpLWludmVzdGl0aWkuYXNweGRkAgsPDxYCHwQFGy9SQ0EvcmFzcHVuZGVyZS1jaXZpbGEuYXNweGRkAgwPDxYCHwQFGS9DYWxjdWxhdG9ycy9EZWZhdWx0LmFzcHhkZAINDw8WAh8EBRIvSW5mby9EZWZhdWx0LmFzcHhkZAIODw8WAh8EBRsvaW5zdGl0dXRpaS1maW5hbmNpYXJlLmFzcHhkZAIPDw8WAh8DBQdFbmdsaXNoZGQCEA8PFgQeDUFsdGVybmF0ZVRleHQFB0VOR0xJU0gfBQUUL2ltZy9lbi1sYW5ndWFnZS5naWZkZAIRD2QWAgICDw8WAh4HVmlzaWJsZWhkZAIED2QWAgIFD2QWGmYPFgIfAgUPL2ltZy9hcnJvdzEuZ2lmZAIHDw8WBB8EBQkvcnNzLmFzcHgfBQUML2ltZy9yc3MuZ2lmZGQCCA8WAh8DBQowMS8xMC8yMDE0ZAIJDw8WAh8EBQ0vRGVmYXVsdC5hc3B4ZGQCCg8PFgIfBAUUL0Fib3V0L0NvbnRhY3RzLmFzcHhkZAILDw8WAh8EBRMvQWR2ZXJ0aXNlbWVudC5hc3B4ZGQCDA8PFgIfBAUYL3Jlc3Vyc2Utd2VibWFzdGVyaS5hc3B4ZGQCDQ8PFgIfBAUUL2Fib3V0L3BhcnRuZXJzLmFzcHhkZAIODw8WAh8EBREvU2l0ZU1hcFRyZWUuYXNweGRkAg8PDxYCHwQFDS9Qcml2YWN5LmFzcHhkZAIQDw8WAh8EBQkvRkFRLmFzcHhkZAIRDw8WAh8EBQ4vR2xvc3NhcnkuYXNweGRkAhIPDxYCHwMFB0VuZ2xpc2hkZAIFD2QWAgIBDxYCHwMFixA8dGFibGU+DQogICAgICAgIDx0cj48dGQgY2xhc3M9J2FkdicgdmFsaWduPSd0b3AnIGFsaWduPSdsZWZ0Jz5QVUJMSUNJVEFURTwvdGQ+PC90cj4NCiAgICAgICAgPHRyPjx0ZD48c2NyaXB0IGxhbmd1YWdlPSdKYXZhU2NyaXB0JyB0eXBlPSd0ZXh0L2phdmFzY3JpcHQnPgogdmFyIG0zX3IgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqOTk5OTk5OTk5OTkpOwoKPCEtLQpkb2N1bWVudC53cml0ZSAoIjwiICsgInNjcmlwdCBsYW5ndWFnZT0nSmF2YVNjcmlwdCcgdHlwZT0ndGV4dC9qYXZhc2NyaXB0JyBzcmM9JyIpO2RvY3VtZW50LndyaXRlICgiaHR0cDovL2Fkcy5maW56b29tLnJvLy9hZGpzLnBocD93aGF0PXpvbmU6OTAmYW1wO2NiPSIrbTNfcik7aWYoZG9jdW1lbnQucmVmZXJyZXIpZG9jdW1lbnQud3JpdGUoIiZhbXA7cmVmZXJlcj0iICsgZXNjYXBlKGRvY3VtZW50LnJlZmVycmVyKSk7ZG9jdW1lbnQud3JpdGUoIic+PCIgKyAiL3NjcmlwdD4iKTsKLy8tLT4KPC9zY3JpcHQ+PG5vc2NyaXB0PjxhIGNsYXNzPSdzdHItdHh0LXNlYycgaHJlZj0naHR0cDovL2Fkcy5maW56b29tLnJvLy9hZGNsaWNrLnBocCcgdGFyZ2V0PSdfYmxhbmsnPjxpbWcgc3JjPSdodHRwOi8vYWRzLmZpbnpvb20ucm8vL2Fkdmlldy5waHA/d2hhdD16b25lOjkwJyBib3JkZXI9JzAnIGFsdD0nJz48L2E+PC9ub3NjcmlwdD48L3RkPjwvdHI+DQogICAgICAgIDx0cj48dGQgY2xhc3M9J2FkdicgdmFsaWduPSd0b3AnIGFsaWduPSdsZWZ0Jz48L3RkPjwvdHI+DQogICAgICAgIDx0cj48dGQ+PHNjcmlwdCBsYW5ndWFnZT0nSmF2YVNjcmlwdCcgdHlwZT0ndGV4dC9qYXZhc2NyaXB0Jz4KIHZhciBtM19yID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKjk5OTk5OTk5OTk5KTsKCjwhLS0KZG9jdW1lbnQud3JpdGUgKCI8IiArICJzY3JpcHQgbGFuZ3VhZ2U9J0phdmFTY3JpcHQnIHR5cGU9J3RleHQvamF2YXNjcmlwdCcgc3JjPSciKTtkb2N1bWVudC53cml0ZSAoImh0dHA6Ly9hZHMuZmluem9vbS5yby8vYWRqcy5waHA/d2hhdD16b25lOjAmYW1wO2NiPSIrbTNfcik7aWYoZG9jdW1lbnQucmVmZXJyZXIpZG9jdW1lbnQud3JpdGUoIiZhbXA7cmVmZXJlcj0iICsgZXNjYXBlKGRvY3VtZW50LnJlZmVycmVyKSk7ZG9jdW1lbnQud3JpdGUoIic+PCIgKyAiL3NjcmlwdD4iKTsKLy8tLT4KPC9zY3JpcHQ+PG5vc2NyaXB0PjxhIGNsYXNzPSdzdHItdHh0LXNlYycgaHJlZj0naHR0cDovL2Fkcy5maW56b29tLnJvLy9hZGNsaWNrLnBocCcgdGFyZ2V0PSdfYmxhbmsnPjxpbWcgc3JjPSdodHRwOi8vYWRzLmZpbnpvb20ucm8vL2Fkdmlldy5waHA/d2hhdD16b25lOjAnIGJvcmRlcj0nMCcgYWx0PScnPjwvYT48L25vc2NyaXB0PjwvdGQ+PC90cj4NCiAgICAgICAgPHRyPjx0ZCBjbGFzcz0nYWR2JyB2YWxpZ249J3RvcCcgYWxpZ249J2xlZnQnPjwvdGQ+PC90cj4NCiAgICAgICAgPHRyPjx0ZD48c2NyaXB0IGxhbmd1YWdlPSdKYXZhU2NyaXB0JyB0eXBlPSd0ZXh0L2phdmFzY3JpcHQnPgogdmFyIG0zX3IgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqOTk5OTk5OTk5OTkpOwoKPCEtLQpkb2N1bWVudC53cml0ZSAoIjwiICsgInNjcmlwdCBsYW5ndWFnZT0nSmF2YVNjcmlwdCcgdHlwZT0ndGV4dC9qYXZhc2NyaXB0JyBzcmM9JyIpO2RvY3VtZW50LndyaXRlICgiaHR0cDovL2Fkcy5maW56b29tLnJvLy9hZGpzLnBocD93aGF0PXpvbmU6MCZhbXA7Y2I9IittM19yKTtpZihkb2N1bWVudC5yZWZlcnJlcilkb2N1bWVudC53cml0ZSgiJmFtcDtyZWZlcmVyPSIgKyBlc2NhcGUoZG9jdW1lbnQucmVmZXJyZXIpKTtkb2N1bWVudC53cml0ZSgiJz48IiArICIvc2NyaXB0PiIpOwovLy0tPgo8L3NjcmlwdD48bm9zY3JpcHQ+PGEgY2xhc3M9J3N0ci10eHQtc2VjJyBocmVmPSdodHRwOi8vYWRzLmZpbnpvb20ucm8vL2FkY2xpY2sucGhwJyB0YXJnZXQ9J19ibGFuayc+PGltZyBzcmM9J2h0dHA6Ly9hZHMuZmluem9vbS5yby8vYWR2aWV3LnBocD93aGF0PXpvbmU6MCcgYm9yZGVyPScwJyBhbHQ9Jyc+PC9hPjwvbm9zY3JpcHQ+PC90ZD48L3RyPjwvdGFibGU+ZAIGD2QWAmYPFgIeBXN0eWxlBeEBYmFja2dyb3VuZC1yZXBlYXQ6bm8tcmVwZWF0O3RleHQtYWxpZ246Y2VudGVyO3dpZHRoOjQ0NXB4O2JvdHRvbTo1N3B4O3otaW5kZXg6MTAwMDAwO2hlaWdodDoyMzVweDtwb3NpdGlvbjpmaXhlZDtiYWNrZ3JvdW5kLWltYWdlOnVybCgvaW1nL2J1YmJsZS5wbmcpO2Rpc3BsYXk6bm9uZTttYXJnaW46YXV0bzt2ZXJ0aWNhbC1hbGlnbjptaWRkbGU7YmFja2dyb3VuZC1wb3NpdGlvbjpjZW50ZXI7FgQCAQ8PFgIfBQUZL2ltZy90cmFuc3BhcmVudC1sb2dvLnBuZ2RkAgMPDxYCHwUFEC9pbWcvY2xvc2UteC5wbmdkZBgBBR5fX0NvbnRyb2xzUmVxdWlyZVBvc3RCYWNrS2V5X18WAQUnX2N0bDA6U2l0ZU1lbnUxOmxua0J0bkNoYW5nZUxhbmd1YWdlSW1n";
	// a NOT vulnerable VIEWSTATE
	// vs = "/wEPDwUKLTEwNTI0MjkwNQ9kFgICAQ9kFgICAQ9kFgQCAQ8WBB4EaHJlZgUKbG9naW4uYXNweB4JaW5uZXJodG1sBQVsb2dpbmQCAw8WBB8AZB4HVmlzaWJsZWhkZDUAskqLyfS1MBsZINJY6LpGzdzU";
	
	if(vs.isValid) {
		//trace("viewstate is valid.");	
			
		vs.consume();
		var c = vs.components();
		//traceObject(c);
		
		if (c.length > 0) {
			lastElement = c[c.length-1];			
			
			if (lastElement.m_id && (lastElement.m_id != "SHA1" && lastElement.m_id != "MD5" && lastElement.m_id != "byte")) {
				//trace("viewstate MAC is NOT enabled!");
				//trace(lastElement.m_id);
				return false;
			}
		}		
	}
	
	return true;
}